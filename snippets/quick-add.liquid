{%- doc -%}
  Renders a quick add component.

  @param {object} product - The product object
  @param {string} section_id - The section ID
  @param {object} [block] - The block object
{%- enddoc -%}

{% liquid
  assign product_form_id = 'QuickAdd-ProductForm-' | append: product.id | append: '-' | append: block.id
  assign add_to_cart_text = 'actions.add' | t

  # Logic to determine which variant to use (matching swatch selection logic from product-card)
  assign variant_to_use = product.selected_or_first_available_variant
  assign combined_listing_count = product.options_with_values | map: 'values' | map: 'product_url' | compact | size

  unless combined_listing_count > 0
    assign first_image = product.media.first
    assign variant_images = product.images | where: 'attached_to_variant?', true
    # Get swatchable options (options that have swatch values)
    assign swatch_variant_picker = null
    for option in product.options_with_values
      assign swatch_count = option.values | map: 'swatch' | compact | size
      if swatch_count > 0
        assign swatch_variant_picker = option
        break
      endif
    endfor

    if swatch_variant_picker
      assign swatch_count = swatch_variant_picker.values | map: 'swatch' | compact | size

      if swatch_count == 1
        # Single swatch: use that variant
        assign variant_to_use = swatch_variant_picker.values.first.variant
      elsif swatch_count > 1
        if first_image and variant_images contains first_image
          # First image is a variant image - find which variant it belongs to
          for option_value in swatch_variant_picker.values
            if option_value.variant.featured_media.id == first_image.id
              assign variant_to_use = option_value.variant
              break
            endif
          endfor
        elsif variant_images.size == 0
          # No variants have images - use first swatch variant
          assign variant_to_use = swatch_variant_picker.values.first.variant
        endif
        # else: First image is NOT a variant image - keep default (selected_or_first_available_variant)
      endif
    endif
  endunless

  if variant_to_use.available
    assign can_add_to_cart = true
  else
    assign can_add_to_cart = false
  endif
%}

<quick-add-component
  class="quick-add color-{{ settings.quick_add_color_scheme }} "
  ref="quickAdd"
  data-product-title="{{ product.title }}"
>
  <product-form-component
    data-section-id="{{ section_id }}"
    data-product-id="{{ product.id }}"
    on:submit="/handleSubmit"
    class="
      quick-add__product-form-component
      {% if product.options.size == 1 %} quick-add__product-form-component--single-option {% else %} quick-add__product-form-component--multi-option {% endif %}
      {% if product.variants.size == 1 %} quick-add__product-form-component--single-variant {% else %} quick-add__product-form-component--multi-variant {% endif %}
    "
  >
    <div
      class="visually-hidden"
      aria-live="assertive"
      role="status"
      aria-atomic="true"
      ref="liveRegion"
    ></div>
    {%- form 'product', product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
      <input
        type="hidden"
        name="id"
        ref="variantId"
        value="{{ variant_to_use.id }}"
        {% if variant_to_use.available == false %}
          disabled
        {% endif %}
      >
      <input
        type="hidden"
        name="quantity"
        value="{% if variant_to_use.quantity_rule.min %}{{ variant_to_use.quantity_rule.min }}{% else %}1{% endif %}"
      >
      {% comment %} If there is one variant option but it's swatches or if it's a single variant product, then use add to cart button {% endcomment %}
      {%- if product.variants.size == 1 or product.options.size == 1 -%}
        {% render 'add-to-cart-button',
          add_to_cart_text: add_to_cart_text,
          class: 'button quick-add__button quick-add__button--add',
          can_add_to_cart: can_add_to_cart,
          icon_only_on_mobile: true,
          product: product
        %}
      {%- endif -%}
      {%- if product.variants.size > 1 -%}
        <button
          class="button quick-add__button quick-add__button--choose"
          type="button"
          name="+"
          on:click="quick-add-component/handleClick"
        >
          <span class="plus-icon">+</span>
          <span class="add-to-cart-text">
            <span class="add-to-cart-text__content is-visually-hidden-mobile">
              {{ add_to_cart_text }}
            </span>
          </span>
        </button>
      {%- endif -%}
    {%- endform -%}
  </product-form-component>
</quick-add-component>

{% stylesheet %}
  /* Quick Add */
  .quick-add {
    --quick-add-offset: var(--padding-sm);
    --quick-add-top: calc(var(--quick-add-offset) + var(--padding-block-start));
    --quick-add-right: calc(var(--quick-add-offset) + var(--padding-inline-end));
    --quick-add-bottom: calc(var(--quick-add-offset) + var(--padding-block-end));
    --quick-add-left: calc(var(--quick-add-offset) + var(--padding-inline-end));

    position: absolute;
    display: flex !important;
    flex-direction: column;
    justify-content: flex-start;
    inset: max(var(--quick-add-top), calc((var(--border-radius) + var(--quick-add-top)) * (1 - cos(45deg))))
      max(var(--quick-add-right), calc((var(--border-radius) + var(--quick-add-right)) * (1 - cos(45deg))))
      max(var(--quick-add-bottom), calc((var(--border-radius) + var(--quick-add-bottom)) * (1 - cos(45deg))))
      max(var(--quick-add-left), calc((var(--border-radius) + var(--quick-add-left)) * (1 - cos(45deg))));
    width: auto;
    height: auto;
    z-index: var(--layer-raised);
    cursor: default;
    pointer-events: auto;

    @media screen and (min-width: 750px) {
      --quick-add-offset: var(--padding-md);
      display: flex !important;
    }
  }

  .quick-add .variant-option__button-label input[data-option-available='false'] {
    cursor: not-allowed;
  }

  .quick-add[class*='color-scheme-'] {
    background-color: transparent;
  }

  /* --- FIXED ROUND + BUTTON --- */
  .quick-add__button {
    display: flex !important;
    align-items: center;
    justify-content: center;
    font-size: 1rem; /* size of + */
    font-weight: bold;
    background-color: #fff; /* white background */
    color: #000; /* black + */
    border: 1px solid #ddd; /* subtle border */
    pointer-events: all;
    border-radius: 50%; /* round button */
    width: 1.5rem; /* button size */
    height: 1.5rem;
    padding: 0;
    line-height: 1;
    cursor: pointer;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* remove hover effect completely */
  .quick-add__button:hover {
    background-color: #fff;
    color: #000;
    transform: none;
  }

  /* Ensure text never shows */
  .quick-add__button .add-to-cart-text,
  .quick-add__button .add-to-cart-text__content {
    display: none !important;
  }

  /* ATC states (still supported, but no text shown) */
  .quick-add__button.atc-added .add-to-cart-text,
  .quick-add__button.atc-added .add-to-cart-text--added {
    display: none !important;
  }

  .quick-add__product-form-component {
    height: 100%;
  }

  .quick-add__product-form-component .shopify-product-form {
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    container-type: inline-size;
    height: 100%;
  }

  .quick-add-modal .product-media {
    width: 100%;
    height: 100%;
  }

  .quick-add-modal deferred-media {
    display: none;
  }

  .quick-add-modal .media-gallery--carousel slideshow-component {
    --cursor: default;
  }

  @keyframes atc-fade-in {
    from {
      opacity: 0;
      transform: translateX(1em);
      position: absolute;
    }
    to {
      opacity: 1;
      transform: translateX(0);
      position: inherit;
    }
  }

  @keyframes atc-fade-out {
    from {
      opacity: 1;
      transform: translateX(0);
      position: inherit;
    }
    to {
      opacity: 0;
      transform: translateX(-1em);
      position: absolute;
    }
  }

  /* Mobile-specific styles to ensure plus icon visibility */
  @media screen and (max-width: 749px) {
    .quick-add {
      display: flex !important;
      pointer-events: auto !important;
    }
    
    .quick-add__button {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: all !important;
    }
    
    .plus-icon {
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
  }
{% endstylesheet %}
